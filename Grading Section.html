<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grading Management</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-5xl mx-auto bg-white p-6 rounded-xl shadow-md">
    <h2 class="text-3xl font-bold mb-6 text-blue-700">Grading Management</h2>

    <!-- Message for unauthorized access -->
    <div id="unauthorized-msg" class="text-red-600 text-lg mb-4 hidden">You do not have permission to modify grades.</div>

    <!-- Grading Form -->
    <div id="grading-form-container" class="mb-6 hidden">
      <form id="grading-form" class="space-y-4">
        <input type="text" id="grade" placeholder="Grade (e.g., A)" class="w-full p-2 border rounded" required>
        <input type="number" id="min-marks" placeholder="Minimum Marks" class="w-full p-2 border rounded" required>
        <input type="number" id="max-marks" placeholder="Maximum Marks" class="w-full p-2 border rounded" required>
        <div class="flex gap-3">
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save Grade</button>
          <button type="button" onclick="cancelEdit()" id="cancel-edit" class="hidden bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel Edit</button>
        </div>
      </form>
    </div>

    <!-- Export Buttons -->
    <div class="flex justify-end space-x-3 mb-4">
      <button onclick="exportCSV()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Export CSV</button>
      <button onclick="generatePDF()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Generate PDF</button>
    </div>

    <!-- Grading Table -->
    <table class="w-full text-left border rounded border-gray-300 mb-6">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-2">Grade</th>
          <th class="p-2">Min Marks</th>
          <th class="p-2">Max Marks</th>
          <th class="p-2" id="actions-header" class="hidden">Actions</th>
        </tr>
      </thead>
      <tbody id="grading-body" class="bg-white">
        <!-- Dynamic rows -->
      </tbody>
    </table>

    <div id="no-data" class="text-center text-gray-500 mb-6">No grades added yet.</div>

    <!-- Chart -->
    <canvas id="gradingChart" class="w-full h-64"></canvas>
  </div>

  <script>
    const role = localStorage.getItem("role");
    const grades = JSON.parse(localStorage.getItem("gradesData")) || [];
    const form = document.getElementById("grading-form");
    const body = document.getElementById("grading-body");
    const cancelEditBtn = document.getElementById("cancel-edit");
    const noDataMsg = document.getElementById("no-data");

    let editingIndex = null;

    function hasEditAccess() {
      return role === "faculty" || role === "admin";
    }

    // Show/Hide form and controls based on role
    if (hasEditAccess()) {
      document.getElementById("grading-form-container").classList.remove("hidden");
      document.getElementById("actions-header").classList.remove("hidden");
    } else {
      document.getElementById("unauthorized-msg").classList.remove("hidden");
    }

    // Save grade
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const grade = document.getElementById("grade").value.trim();
      const min = parseInt(document.getElementById("min-marks").value);
      const max = parseInt(document.getElementById("max-marks").value);

      if (min > max) {
        alert("Minimum marks cannot be greater than maximum marks.");
        return;
      }

      const newGrade = { grade, min, max };

      if (editingIndex !== null) {
        grades[editingIndex] = newGrade;
        editingIndex = null;
        cancelEditBtn.classList.add("hidden");
      } else {
        grades.push(newGrade);
      }

      form.reset();
      saveAndRender();
    });

    function editGrade(index) {
      const g = grades[index];
      document.getElementById("grade").value = g.grade;
      document.getElementById("min-marks").value = g.min;
      document.getElementById("max-marks").value = g.max;
      editingIndex = index;
      cancelEditBtn.classList.remove("hidden");
    }

    function cancelEdit() {
      editingIndex = null;
      form.reset();
      cancelEditBtn.classList.add("hidden");
    }

    function deleteGrade(index) {
      if (confirm("Are you sure you want to delete this grade?")) {
        grades.splice(index, 1);
        saveAndRender();
      }
    }

    function saveAndRender() {
      localStorage.setItem("gradesData", JSON.stringify(grades));
      renderTable();
      renderChart();
    }

    function renderTable() {
      body.innerHTML = "";
      noDataMsg.style.display = grades.length === 0 ? "block" : "none";

      grades.forEach((g, i) => {
        let row = `<tr class="border-t">
          <td class="p-2">${g.grade}</td>
          <td class="p-2">${g.min}</td>
          <td class="p-2">${g.max}</td>`;
        if (hasEditAccess()) {
          row += `<td class="p-2">
            <button onclick="editGrade(${i})" class="text-blue-600">Edit</button>
            <button onclick="deleteGrade(${i})" class="text-red-600 ml-2">Delete</button>
          </td>`;
        }
        row += "</tr>";
        body.innerHTML += row;
      });
    }

    function renderChart() {
      const ctx = document.getElementById("gradingChart").getContext("2d");
      if (window.gradingChart) window.gradingChart.destroy();

      window.gradingChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: grades.map(g => g.grade),
          datasets: [{
            label: "Range Width",
            data: grades.map(g => g.max - g.min),
            backgroundColor: "rgba(54, 162, 235, 0.6)",
            borderColor: "rgba(54, 162, 235, 1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: "Marks Range" }
            }
          }
        }
      });
    }

    function exportCSV() {
      const rows = [
        ["Grade", "Min Marks", "Max Marks"],
        ...grades.map(g => [g.grade, g.min, g.max])
      ];
      const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "grading_data.csv");
      document.body.appendChild(link);
      link.click();
      link.remove();
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.text("Grading Data", 14, 20);
      doc.setFontSize(12);

      let y = 30;
      grades.forEach((g, i) => {
        doc.text(`${i + 1}. Grade: ${g.grade}, Min: ${g.min}, Max: ${g.max}`, 14, y);
        y += 8;
      });
      doc.save("grading_data.pdf");
    }

    // Initialize
    saveAndRender();
  </script>
</body>
</html>
