<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Examination Management</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-6xl mx-auto p-6">
    <h2 class="text-3xl font-bold mb-6 text-center">ðŸ“˜ Examination Management</h2>

    <!-- Form Section -->
    <form id="exams-form" class="bg-white p-6 rounded-lg shadow-md mb-6 space-y-4 hidden">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <input type="text" id="student-id" placeholder="Student ID" required class="border p-2 rounded w-full"/>
        <input type="text" id="subject" placeholder="Subject" required class="border p-2 rounded w-full"/>
        <input type="number" id="marks" placeholder="Marks" required class="border p-2 rounded w-full"/>
      </div>
      <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Submit</button>
    </form>

    <!-- Filter Section -->
    <div class="mb-4 flex flex-wrap gap-4" id="filters">
      <input type="text" id="filter-student-id" placeholder="Filter by Student ID" class="border p-2 rounded"/>
      <input type="text" id="filter-subject" placeholder="Filter by Subject" class="border p-2 rounded"/>
      <button onclick="exportCSV()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Export CSV</button>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white rounded-lg shadow-md" id="exams-table">
        <thead class="bg-gray-200">
          <tr>
            <th class="text-left py-2 px-4">Student ID</th>
            <th class="text-left py-2 px-4">Subject</th>
            <th class="text-left py-2 px-4">Marks</th>
            <th class="text-left py-2 px-4">Actions</th>
          </tr>
        </thead>
        <tbody id="table-body" class="divide-y divide-gray-100">
        </tbody>
      </table>
    </div>

    <!-- Chart -->
    <div class="mt-10 bg-white p-6 rounded shadow-md">
      <h3 class="text-xl font-semibold mb-4">ðŸ“Š Marks Summary</h3>
      <canvas id="marksChart"></canvas>
    </div>
  </div>

  <script>
    const tableBody = document.getElementById('table-body');
    const chartCtx = document.getElementById('marksChart').getContext('2d');
    const form = document.getElementById("exams-form");
    const role = localStorage.getItem("role");
    const currentStudentId = localStorage.getItem("studentId");

    let records = [
      { studentId: "S123", subject: "Math", marks: 80 },
      { studentId: "S123", subject: "Science", marks: 85 },
      { studentId: "S456", subject: "Math", marks: 75 },
      { studentId: "S789", subject: "History", marks: 90 },
    ];
    let chart;

    const isFaculty = role === "faculty";
    const isStudent = role === "student";
    const isParent = role === "parent";

    // Show form only for faculty
    if (isFaculty) {
      form.classList.remove("hidden");
    }

    function getVisibleRecords() {
      if (isFaculty) return records;
      if (isStudent || isParent) {
        return records.filter(r => r.studentId === currentStudentId);
      }
      return [];
    }

    function renderTable() {
      tableBody.innerHTML = "";

      const studentFilter = document.getElementById("filter-student-id").value.toLowerCase();
      const subjectFilter = document.getElementById("filter-subject").value.toLowerCase();

      const filtered = getVisibleRecords().filter(r =>
        r.studentId.toLowerCase().includes(studentFilter) &&
        r.subject.toLowerCase().includes(subjectFilter)
      );

      filtered.forEach((r, i) => {
        const globalIndex = records.indexOf(r);
        tableBody.innerHTML += `
          <tr>
            <td class="py-2 px-4">${r.studentId}</td>
            <td class="py-2 px-4">${r.subject}</td>
            <td class="py-2 px-4">${r.marks}</td>
            <td class="py-2 px-4">
              ${isFaculty ? `
                <button onclick="editRecord(${globalIndex})" class="text-blue-600 hover:underline">Edit</button>
                <button onclick="deleteRecord(${globalIndex})" class="text-red-600 hover:underline ml-2">Delete</button>
              ` : 'N/A'}
            </td>
          </tr>
        `;
      });

      updateChart(filtered);
    }

    function updateChart(data) {
      const subjects = [...new Set(data.map(r => r.subject))];
      const averages = subjects.map(sub =>
        Math.round(data.filter(r => r.subject === sub).reduce((sum, r) => sum + Number(r.marks), 0) /
        data.filter(r => r.subject === sub).length)
      );

      if (chart) chart.destroy();
      chart = new Chart(chartCtx, {
        type: 'bar',
        data: {
          labels: subjects,
          datasets: [{
            label: 'Average Marks',
            data: averages,
            backgroundColor: 'rgba(59, 130, 246, 0.7)'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function editRecord(index) {
      const r = records[index];
      document.getElementById("student-id").value = r.studentId;
      document.getElementById("subject").value = r.subject;
      document.getElementById("marks").value = r.marks;
      records.splice(index, 1);
      renderTable();
    }

    function deleteRecord(index) {
      if (confirm("Are you sure you want to delete this record?")) {
        records.splice(index, 1);
        renderTable();
      }
    }

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const studentId = document.getElementById("student-id").value.trim();
      const subject = document.getElementById("subject").value.trim();
      const marks = parseInt(document.getElementById("marks").value.trim());

      if (studentId && subject && !isNaN(marks)) {
        records.push({ studentId, subject, marks });
        renderTable();
        form.reset();
      }
    });

    document.getElementById("filter-student-id").addEventListener("input", renderTable);
    document.getElementById("filter-subject").addEventListener("input", renderTable);

    function exportCSV() {
      const visibleRecords = getVisibleRecords();
      const csv = [
        ["Student ID", "Subject", "Marks"],
        ...visibleRecords.map(r => [r.studentId, r.subject, r.marks])
      ].map(e => e.join(",")).join("\n");

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "exam_records.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    renderTable();
  </script>
</body>
</html>
